<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Fertilizer Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-blue: #1e5aa0;
            --secondary-blue: #3a8bd5;
            --light-blue: #e8f3ff;
            --dark-blue: #0f3a73;
            --primary-green: #2d9c5e;
            --secondary-green: #4bc177;
            --light-green: #f0f9f4;
            --dark-green: #1d6e3f;
            --accent: #4bc177;
            --gray: #6c757d;
            --warning: #e74c3c;
            --yellow: #f1c40f;
            --purple: #9b59b6;
            --orange: #e67e22;
        }
        
        body {
            background: linear-gradient(135deg, #f0f7ff 0%, #f0f9f4 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(to right, var(--primary-blue), var(--primary-green));
            color: white;
            padding: 25px 0;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(30, 90, 160, 0.2);
            margin-bottom: 20px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 50%;
        }
        
        .logo h1 {
            font-size: 2.4rem;
            font-weight: 700;
        }
        
        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .help-top-bar {
            background: linear-gradient(to right, var(--orange), #e67e22);
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(230, 126, 34, 0.2);
        }
        
        .help-top-bar h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(30, 90, 160, 0.12);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(30, 90, 160, 0.1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(30, 90, 160, 0.15);
        }
        
        .card-title {
            color: var(--primary-blue);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-blue);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 1.5rem;
        }
        
        .calculator-section {
            grid-column: 1;
        }
        
        .chatbot-section {
            grid-column: 2;
        }
        
        @media (max-width: 1024px) {
            .calculator-section, .chatbot-section {
                grid-column: 1;
            }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 1.05rem;
        }
        
        select, input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #d0e1f5;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9fcff;
        }
        
        select:focus, input:focus {
            border-color: var(--secondary-blue);
            outline: none;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(58, 139, 213, 0.15);
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .npk-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        
        .npk-input {
            text-align: center;
        }
        
        .npk-input label {
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .npk-n { background-color: var(--primary-blue); }
        .npk-p { background-color: var(--secondary-blue); }
        .npk-k { background-color: var(--primary-green); }
        
        .area-input {
            position: relative;
        }
        
        .area-input span {
            position: absolute;
            right: 15px;
            top: 43px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .btn {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background: linear-gradient(to right, var(--dark-blue), var(--primary-blue));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 90, 160, 0.25);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, var(--primary-green), var(--secondary-green));
            margin-top: 15px;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to right, var(--dark-green), var(--primary-green));
        }
        
        .btn-help {
            background: linear-gradient(to right, var(--orange), #e67e22);
            width: auto;
            padding: 12px 25px;
            font-size: 1rem;
            margin-top: 0;
        }
        
        .btn-help:hover {
            background: linear-gradient(to right, #d35400, var(--orange));
        }
        
        .btn-clear {
            background: linear-gradient(to right, #e74c3c, #ff6b6b);
            width: auto;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin-top: 0;
            margin-left: 10px;
        }
        
        .btn-clear:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }
        
        .btn-tutorial {
            background: linear-gradient(to right, var(--yellow), #f39c12);
            width: auto;
            padding: 12px 25px;
            font-size: 1rem;
            margin-top: 0;
        }
        
        .btn-tutorial:hover {
            background: linear-gradient(to right, #d4ac0d, var(--yellow));
        }
        
        .btn-export {
            background: linear-gradient(to right, var(--purple), #8e44ad);
            width: auto;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin-top: 0;
            margin-left: 10px;
        }
        
        .btn-export:hover {
            background: linear-gradient(to right, #8e44ad, var(--purple));
        }
        
        .btn i {
            margin-right: 10px;
        }
        
        .result-card {
            background: linear-gradient(135deg, var(--light-blue) 0%, var(--light-green) 100%);
            border-left: 5px solid var(--primary-green);
            padding: 25px;
            margin-top: 30px;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 3px 10px rgba(30, 90, 160, 0.12);
        }
        
        .result-title {
            color: var(--dark-blue);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-item {
            background-color: white;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .result-label {
            font-size: 0.95rem;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .result-value {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-blue);
        }
        
        .result-value.green {
            color: var(--primary-green);
        }
        
        .result-value.orange {
            color: var(--orange);
        }
        
        .percentage-results {
            background: linear-gradient(135deg, #fff9e6 0%, #fff0cc 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid var(--yellow);
        }
        
        .percentage-results h4 {
            color: var(--dark-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .percentage-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .percentage-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .percentage-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .percentage-value {
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .percentage-n { color: var(--primary-blue); }
        .percentage-p { color: var(--secondary-blue); }
        .percentage-k { color: var(--primary-green); }
        
        .recommendation {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-green);
        }
        
        .recommendation h4 {
            color: var(--dark-blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .help-content {
            background-color: white;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-help {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
        }
        
        .history-section {
            margin-top: 40px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .history-panel {
            background: linear-gradient(135deg, var(--light-blue) 0%, #e1eeff 100%);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #d0e1f5;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 3px 10px rgba(30, 90, 160, 0.1);
        }
        
        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
            font-style: italic;
        }
        
        .history-item {
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-green);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .history-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .history-crop {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }
        
        .history-date {
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        .history-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .history-detail {
            background-color: var(--light-green);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .history-detail-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 3px;
        }
        
        .history-detail-value {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }
        
        .history-detail-value.green {
            color: var(--primary-green);
        }
        
        .history-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-delete-btn {
            background: none;
            border: none;
            color: var(--warning);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s;
        }
        
        .history-delete-btn:hover {
            color: #c0392b;
        }
        
        .chatbot-container {
            display: flex;
            flex-direction: column;
            height: 650px;
        }
        
        .chatbot-header {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chatbot-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chatbot-header i {
            font-size: 1.5rem;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #f9fcff;
            border-left: 1px solid #d0e1f5;
            border-right: 1px solid #d0e1f5;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 85%;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.3s forwards;
            position: relative;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .bot-message {
            background-color: white;
            padding: 15px 20px;
            border-radius: 18px 18px 18px 5px;
            box-shadow: 0 2px 8px rgba(30, 90, 160, 0.1);
            align-self: flex-start;
            border: 1px solid #d0e1f5;
        }
        
        .user-message {
            background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 15px 20px;
            border-radius: 18px 18px 5px 18px;
            margin-left: auto;
            align-self: flex-end;
            box-shadow: 0 2px 8px rgba(30, 90, 160, 0.2);
            position: relative;
        }
        
        .delete-message-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--warning);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .user-message:hover .delete-message-btn {
            display: flex;
        }
        
        .chatbot-input {
            display: flex;
            border-top: 1px solid #d0e1f5;
            background-color: white;
            border-radius: 0 0 10px 10px;
            overflow: hidden;
        }
        
        .chatbot-input input {
            flex: 1;
            border: none;
            padding: 20px;
            font-size: 1rem;
            border-radius: 0;
        }
        
        .chatbot-input button {
            background: linear-gradient(to right, var(--primary-green), var(--secondary-green));
            color: white;
            border: none;
            padding: 0 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .chatbot-input button:hover {
            background: linear-gradient(to right, var(--dark-green), var(--primary-green));
        }
        
        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        
        .quick-q {
            background-color: var(--light-blue);
            border: 1px solid #b8d4ff;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--primary-blue);
            font-weight: 500;
        }
        
        .quick-q:hover {
            background-color: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 90, 160, 0.2);
        }
        
        .chatbot-actions {
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background-color: white;
            border-top: 1px solid #d0e1f5;
        }
        
        .info-section {
            background: linear-gradient(135deg, var(--light-blue) 0%, #e1eeff 100%);
            padding: 30px;
            border-radius: 15px;
            margin-top: 40px;
            border-left: 5px solid var(--primary-blue);
            box-shadow: 0 5px 15px rgba(30, 90, 160, 0.12);
        }
        
        .info-section h3 {
            color: var(--primary-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-section p {
            margin-bottom: 15px;
            color: #444;
            line-height: 1.7;
        }
        
        .highlight {
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        .highlight.green {
            color: var(--primary-green);
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            color: var(--gray);
            border-top: 1px solid #d0e1f5;
        }
        
        .calc-info {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 10px;
            text-align: center;
            font-style: italic;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background-color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #d0e1f5;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--primary-blue);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .npk-inputs {
                grid-template-columns: 1fr;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            .percentage-grid {
                grid-template-columns: 1fr;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .history-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .logo h1 {
                font-size: 2rem;
            }
            
            .card-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .help-top-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-calculator"></i>
                    <div>
                        <h1>Smart Fertilizer Calculator</h1>
                        <p class="tagline">Calculate NPK percentages for optimal crop growth</p>
                    </div>
                </div>
                <div>
                    <p>NPK Percentage Calculator with Soil & Crop Analysis</p>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Top Help Bar -->
        <div class="help-top-bar">
            <h3><i class="fas fa-question-circle"></i> Need help using this app?</h3>
            <button class="btn-help" id="helpBtn">
                <i class="fas fa-question-circle"></i> How to Use This App
            </button>
        </div>
        
        <div class="app-container">
            <!-- Calculator Section -->
            <section class="calculator-section card">
                <h2 class="card-title">
                    <span><i class="fas fa-calculator"></i> NPK Percentage Calculator</span>
                </h2>
                
                <div class="form-group">
                    <label for="cropType">Select Crop Type</label>
                    <select id="cropType">
                        <option value="">-- Select a crop --</option>
                        <option value="wheat">Wheat</option>
                        <option value="rice">Rice</option>
                        <option value="corn">Corn (Maize)</option>
                        <option value="sorghum">Sorghum</option>
                        <option value="barley">Barley</option>
                        <option value="soybean">Soybean</option>
                        <option value="tomato">Tomato</option>
                        <option value="potato">Potato</option>
                        <option value="onion">Onion</option>
                        <option value="carrot">Carrot</option>
                        <option value="cabbage">Cabbage</option>
                        <option value="cucumber">Cucumber</option>
                        <option value="pepper">Pepper</option>
                        <option value="strawberry">Strawberry</option>
                        <option value="grape">Grape</option>
                        <option value="apple">Apple</option>
                        <option value="orange">Orange</option>
                        <option value="banana">Banana</option>
                        <option value="cotton">Cotton</option>
                        <option value="sugarcane">Sugarcane</option>
                        <option value="coffee">Coffee</option>
                    </select>
                </div>
                
                <div class="input-row">
                    <div class="form-group">
                        <label for="soilType">Soil Type</label>
                        <select id="soilType">
                            <option value="clay">Clay Soil</option>
                            <option value="loam" selected>Loam Soil</option>
                            <option value="sandy">Sandy Soil</option>
                            <option value="silty">Silty Soil</option>
                            <option value="peat">Peat Soil</option>
                            <option value="chalky">Chalky Soil</option>
                        </select>
                    </div>
                    
                    <div class="form-group area-input">
                        <label for="area">Field Size</label>
                        <input type="number" id="area" min="0.1" max="10000" value="5" step="0.1">
                        <span>hectares</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Current Soil NPK Levels (kg/ha)</label>
                    <div class="npk-inputs">
                        <div class="npk-input">
                            <label class="npk-n">Nitrogen (N)</label>
                            <input type="number" id="soilN" min="0" max="500" value="25" step="1">
                        </div>
                        <div class="npk-input">
                            <label class="npk-p">Phosphorus (P)</label>
                            <input type="number" id="soilP" min="0" max="500" value="18" step="1">
                        </div>
                        <div class="npk-input">
                            <label class="npk-k">Potassium (K)</label>
                            <input type="number" id="soilK" min="0" max="500" value="30" step="1">
                        </div>
                    </div>
                </div>
                
                <button class="btn" id="calculateBtn">
                    <i class="fas fa-calculator"></i> Calculate NPK Percentages
                </button>
                
                <button class="btn btn-tutorial" id="tutorialBtn">
                    <i class="fab fa-youtube"></i> Watch NPK Tutorial Video
                </button>
                
                <div id="resultContainer" class="result-card" style="display: none;">
                    <h3 class="result-title">
                        <i class="fas fa-chart-bar"></i> NPK Percentage Results
                    </h3>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Required Nitrogen (N)</div>
                            <div id="nResult" class="result-value">0 kg</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Required Phosphorus (P)</div>
                            <div id="pResult" class="result-value">0 kg</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Required Potassium (K)</div>
                            <div id="kResult" class="result-value green">0 kg</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Total NPK Requirement</div>
                            <div id="totalResult" class="result-value orange">0 kg</div>
                        </div>
                    </div>
                    
                    <div class="percentage-results">
                        <h4><i class="fas fa-percentage"></i> NPK Percentage Composition</h4>
                        <div class="percentage-grid">
                            <div class="percentage-item">
                                <div class="percentage-label">Nitrogen (N) %</div>
                                <div id="nPercentage" class="percentage-value percentage-n">0%</div>
                            </div>
                            <div class="percentage-item">
                                <div class="percentage-label">Phosphorus (P) %</div>
                                <div id="pPercentage" class="percentage-value percentage-p">0%</div>
                            </div>
                            <div class="percentage-item">
                                <div class="percentage-label">Potassium (K) %</div>
                                <div id="kPercentage" class="percentage-value percentage-k">0%</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: var(--gray); text-align: center;">
                            <i class="fas fa-info-circle"></i> Formula: (Individual NPK ÷ Total NPK) × 100 = Percentage
                        </p>
                    </div>
                    
                    <div class="recommendation">
                        <h4><i class="fas fa-lightbulb"></i> Smart Recommendation</h4>
                        <p id="recommendationText">Based on your inputs, here are fertilizer recommendations for optimal crop growth.</p>
                    </div>
                </div>
            </section>
            
            <!-- Chatbot Section -->
            <section class="chatbot-section card">
                <h2 class="card-title">
                    <span><i class="fas fa-robot"></i> Agriculture Assistant</span>
                    <button class="btn-clear" id="clearChatBtn">
                        <i class="fas fa-trash-alt"></i> Clear Chat
                    </button>
                </h2>
                
                <div class="chatbot-container">
                    <div class="chatbot-header">
                        <div class="chatbot-header-left">
                            <i class="fas fa-robot"></i>
                            <h3>Ask me about agriculture, fertilizers, or crops</h3>
                        </div>
                        <div>
                            <span id="messageCount">0 messages</span>
                        </div>
                    </div>
                    
                    <div class="chatbot-messages" id="chatMessages">
                        <div class="message bot-message">
                            Hello! I'm your Agriculture Assistant. I can answer questions about fertilizer calculations, NPK ratios, crop management, soil science, and all agriculture-related topics. How can I help you today?
                        </div>
                    </div>
                    
                    <div class="chatbot-input">
                        <input type="text" id="chatInput" placeholder="Ask about agriculture, fertilizers, crops...">
                        <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    
                    <div class="chatbot-actions">
                        <button class="btn-clear" id="deleteLastMessageBtn">
                            <i class="fas fa-backspace"></i> Delete Last Message
                        </button>
                    </div>
                    
                    <div class="quick-questions">
                        <div class="quick-q" data-question="What is NPK ratio?">NPK ratio explained</div>
                        <div class="quick-q" data-question="How to calculate NPK percentage?">Calculate NPK %</div>
                        <div class="quick-q" data-question="What is fertilizer?">Define fertilizer</div>
                        <div class="quick-q" data-question="Best fertilizer for tomatoes?">Tomato fertilizer</div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- History Section -->
        <section class="history-section">
            <div class="history-header">
                <h2 class="card-title">
                    <i class="fas fa-history"></i> Calculation History
                </h2>
                <div>
                    <button class="btn-export" id="exportHistoryBtn">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn-clear" id="clearHistoryBtn">
                        <i class="fas fa-trash-alt"></i> Clear All
                    </button>
                </div>
            </div>
            
            <div class="stats-bar" id="historyStats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCalculations">0</div>
                    <div class="stat-label">Total Calculations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="mostCalculatedCrop">-</div>
                    <div class="stat-label">Most Calculated Crop</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalArea">0</div>
                    <div class="stat-label">Total Area (ha)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgNPK">0</div>
                    <div class="stat-label">Avg NPK (kg)</div>
                </div>
            </div>
            
            <div class="history-panel" id="historyPanel">
                <div class="history-empty" id="emptyHistoryMessage">
                    <i class="fas fa-history fa-3x" style="color: #d0e1f5; margin-bottom: 15px;"></i>
                    <p>No calculation history yet. Perform calculations to see them here.</p>
                </div>
                <!-- History items will be dynamically added here -->
            </div>
        </section>
        
        <!-- Information Section -->
        <section class="info-section">
            <h3><i class="fas fa-info-circle"></i> About This Calculator</h3>
            <p>This Smart Fertilizer Calculator helps farmers and agricultural professionals determine the precise NPK (Nitrogen, Phosphorus, Potassium) requirements for various crops. All calculations are automatically saved to your browser's local storage and can be reviewed, exported, or cleared at any time.</p>
            <p>The calculator uses scientifically validated formulas to provide accurate recommendations for optimal crop growth and yield. The integrated Agriculture Assistant can answer all your questions about fertilizers, crop management, soil science, and agricultural practices.</p>
        </section>
    </div>
    
    <!-- Help Modal -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <button class="close-help" id="closeHelpBtn">&times;</button>
            <h2><i class="fas fa-question-circle"></i> How to Use This App</h2>
            
            <h3 style="margin-top: 20px; color: var(--primary-blue);">Step-by-Step Guide:</h3>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li><strong>Select Crop Type</strong>: Choose the crop you want to grow from the dropdown list</li>
                <li><strong>Select Soil Type</strong>: Choose your soil type (clay, loam, sandy, etc.)</li>
                <li><strong>Enter Field Size</strong>: Input your cultivation area in hectares</li>
                <li><strong>Enter Soil NPK Levels</strong>: Input current soil Nitrogen, Phosphorus, and Potassium levels</li>
                <li><strong>Click Calculate</strong>: Get NPK requirements and percentage composition</li>
            </ol>
            
            <h3 style="margin-top: 20px; color: var(--primary-blue);">Understanding NPK Percentages:</h3>
            <p>The calculator uses the formula: <strong>(Crop NPK Ratio ÷ Total NPK) × 100 = Percentage</strong></p>
            <p>For example, if a crop needs 20kg N, 10kg P, and 10kg K:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Total NPK = 20 + 10 + 10 = 40</li>
                <li>N % = (20 ÷ 40) × 100 = 50%</li>
                <li>P % = (10 ÷ 40) × 100 = 25%</li>
                <li>K % = (10 ÷ 40) × 100 = 25%</li>
            </ul>
            
            <h3 style="margin-top: 20px; color: var(--primary-blue);">Using the Agriculture Assistant:</h3>
            <p>The chatbot can answer questions about:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Fertilizer definitions and types</li>
                <li>NPK ratio explanations</li>
                <li>Crop-specific fertilizer requirements</li>
                <li>Soil science and management</li>
                <li>Agriculture best practices</li>
            </ul>
            
            <h3 style="margin-top: 20px; color: var(--primary-blue);">Tips for Accurate Calculations:</h3>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Always conduct soil testing for accurate NPK levels</li>
                <li>Consider soil pH when interpreting results</li>
                <li>Adjust for local climate and weather conditions</li>
                <li>Consult with local agricultural experts for specific advice</li>
            </ul>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Smart Fertilizer Calculator &copy; 2023 | NPK Percentage Calculator for Precision Agriculture</p>
            <p>This tool provides recommendations based on standard agricultural practices. Always consult with local agricultural experts for site-specific advice.</p>
        </div>
    </footer>
    
    <script>
        // Comprehensive crop data with Total NPK requirements (in kg per hectare)
        const cropData = {
            wheat: { 
                name: "Wheat", 
                totalNPK: 47, // 25N + 12P + 10K = 47
                npkRatio: { n: 25, p: 12, k: 10 },
                description: "Cereal crop requiring balanced NPK with emphasis on nitrogen for grain development."
            },
            rice: { 
                name: "Rice", 
                totalNPK: 45, // 20N + 10P + 15K = 45
                npkRatio: { n: 20, p: 10, k: 15 },
                description: "Staple food crop needing more nitrogen, especially during tillering and panicle initiation."
            },
            corn: { 
                name: "Corn (Maize)", 
                totalNPK: 70, // 30N + 15P + 25K = 70
                npkRatio: { n: 30, p: 15, k: 25 },
                description: "High-yield cereal with significant nitrogen requirements for optimal growth."
            },
            sorghum: { 
                name: "Sorghum", 
                totalNPK: 50, // 22N + 10P + 18K = 50
                npkRatio: { n: 22, p: 10, k: 18 },
                description: "Drought-resistant cereal with moderate nutrient requirements."
            },
            barley: { 
                name: "Barley", 
                totalNPK: 40, // 18N + 10P + 12K = 40
                npkRatio: { n: 18, p: 10, k: 12 },
                description: "Cereal similar to wheat but with slightly lower nutrient needs."
            },
            soybean: { 
                name: "Soybean", 
                totalNPK: 32, // 5N + 12P + 15K = 32
                npkRatio: { n: 5, p: 12, k: 15 },
                description: "Legume crop that fixes atmospheric nitrogen, requiring more phosphorus."
            },
            tomato: { 
                name: "Tomato", 
                totalNPK: 90, // 35N + 15P + 40K = 90
                npkRatio: { n: 35, p: 15, k: 40 },
                description: "Fruit vegetable requiring high potassium for fruit quality and disease resistance."
            },
            potato: { 
                name: "Potato", 
                totalNPK: 80, // 30N + 15P + 35K = 80
                npkRatio: { n: 30, p: 15, k: 35 },
                description: "Tuber crop needing high potassium for tuber development and quality."
            },
            onion: { 
                name: "Onion", 
                totalNPK: 57, // 25N + 12P + 20K = 57
                npkRatio: { n: 25, p: 12, k: 20 },
                description: "Bulb crop with moderate nutrient requirements, needs sulfur for flavor."
            },
            carrot: { 
                name: "Carrot", 
                totalNPK: 65, // 20N + 15P + 30K = 65
                npkRatio: { n: 20, p: 15, k: 30 },
                description: "Root vegetable requiring high potassium for sweet, well-developed roots."
            },
            cabbage: { 
                name: "Cabbage", 
                totalNPK: 85, // 40N + 15P + 30K = 85
                npkRatio: { n: 40, p: 15, k: 30 },
                description: "Leafy vegetable with high nitrogen requirement for leaf development."
            },
            cucumber: { 
                name: "Cucumber", 
                totalNPK: 80, // 30N + 15P + 35K = 80
                npkRatio: { n: 30, p: 15, k: 35 },
                description: "Vine crop requiring balanced nutrition with emphasis on potassium during fruiting."
            },
            pepper: { 
                name: "Pepper", 
                totalNPK: 67, // 25N + 12P + 30K = 67
                npkRatio: { n: 25, p: 12, k: 30 },
                description: "Fruit vegetable needing moderate nitrogen and high potassium for fruit development."
            },
            strawberry: { 
                name: "Strawberry", 
                totalNPK: 85, // 30N + 15P + 40K = 85
                npkRatio: { n: 30, p: 15, k: 40 },
                description: "Fruit crop requiring high potassium for fruit quality and sweetness."
            },
            grape: { 
                name: "Grape", 
                totalNPK: 75, // 25N + 15P + 35K = 75
                npkRatio: { n: 25, p: 15, k: 35 },
                description: "Vine crop with specific nutrient needs for fruit quality and vine health."
            },
            apple: { 
                name: "Apple", 
                totalNPK: 55, // 20N + 10P + 25K = 55
                npkRatio: { n: 20, p: 10, k: 25 },
                description: "Fruit tree requiring balanced nutrition with emphasis on potassium for fruit quality."
            },
            orange: { 
                name: "Orange", 
                totalNPK: 67, // 25N + 12P + 30K = 67
                npkRatio: { n: 25, p: 12, k: 30 },
                description: "Citrus tree needing balanced NPK with micronutrients for fruit development."
            },
            banana: { 
                name: "Banana", 
                totalNPK: 110, // 45N + 15P + 50K = 110
                npkRatio: { n: 45, p: 15, k: 50 },
                description: "Tropical fruit with very high potassium requirement, heavy feeder."
            },
            cotton: { 
                name: "Cotton", 
                totalNPK: 57, // 25N + 12P + 20K = 57
                npkRatio: { n: 25, p: 12, k: 20 },
                description: "Fiber crop requiring balanced fertilizer with emphasis on potassium for fiber quality."
            },
            sugarcane: { 
                name: "Sugarcane", 
                totalNPK: 90, // 40N + 20P + 30K = 90
                npkRatio: { n: 40, p: 20, k: 30 },
                description: "High biomass crop with significant nitrogen and potassium needs for sugar production."
            },
            coffee: { 
                name: "Coffee", 
                totalNPK: 65, // 25N + 10P + 30K = 65
                npkRatio: { n: 25, p: 10, k: 30 },
                description: "Beverage crop requiring balanced nutrition with emphasis on potassium for bean quality."
            }
        };

        // Soil type adjustment factors
        const soilTypeAdjustments = {
            clay: { n: 1.3, p: 1.4, k: 1.2 },
            loam: { n: 1.0, p: 1.0, k: 1.0 },
            sandy: { n: 0.7, p: 0.6, k: 0.8 },
            silty: { n: 1.1, p: 1.2, k: 1.1 },
            peat: { n: 0.8, p: 1.3, k: 0.9 },
            chalky: { n: 0.9, p: 0.7, k: 1.0 }
        };

        // Recommendations based on crop type
        const recommendations = {
            wheat: "Apply 50% nitrogen at sowing and 50% at first irrigation. Phosphorus fully at sowing. Potassium split between sowing and tillering.",
            rice: "Split nitrogen: 50% basal, 25% tillering, 25% panicle initiation. All phosphorus at transplanting.",
            corn: "Apply 1/3 nitrogen at sowing, 2/3 at knee-high stage. All phosphorus at sowing. Potassium split equally.",
            tomato: "Apply balanced NPK at transplanting. Side dress with additional nitrogen and potassium at flowering.",
            potato: "Apply 2/3 nitrogen and all P/K at planting. Side dress remaining nitrogen at 15-20 cm height.",
            soybean: "Focus on phosphorus application at sowing. Nitrogen not needed (fixes atmospheric N).",
            carrot: "Emphasize potassium for root development. Apply phosphorus at planting for root growth.",
            cabbage: "High nitrogen requirement. Apply in split doses every 2-3 weeks during growth.",
            banana: "Very high potassium requirement. Apply in frequent small doses throughout growth cycle.",
            coffee: "Apply fertilizer in 2-3 split doses during rainy season. Emphasize potassium during fruiting."
        };

        // Chatbot functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const quickQuestions = document.querySelectorAll('.quick-q');
        const messageCount = document.getElementById('messageCount');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const deleteLastMessageBtn = document.getElementById('deleteLastMessageBtn');

        // History elements
        const historyPanel = document.getElementById('historyPanel');
        const emptyHistoryMessage = document.getElementById('emptyHistoryMessage');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');

        // Help modal elements
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const tutorialBtn = document.getElementById('tutorialBtn');

        // Stats elements
        const totalCalculationsEl = document.getElementById('totalCalculations');
        const mostCalculatedCropEl = document.getElementById('mostCalculatedCrop');
        const totalAreaEl = document.getElementById('totalArea');
        const avgNPKEl = document.getElementById('avgNPK');

        // Track message count
        let messages = 0;
        updateMessageCount();

        // Store calculation history in localStorage
        let calculationHistory = JSON.parse(localStorage.getItem('fertilizerHistory')) || [];

        // Track user messages for deletion
        let userMessageElements = [];

        // Initialize
        updateHistoryStats();
        displayHistory();

        // Helper function to round numbers and remove decimals
        function roundNumber(num) {
            return Math.round(num);
        }

        function updateMessageCount() {
            messageCount.textContent = `${messages} messages`;
        }

        function updateHistoryStats() {
            const total = calculationHistory.length;
            totalCalculationsEl.textContent = total;
            
            if (total === 0) {
                mostCalculatedCropEl.textContent = '-';
                totalAreaEl.textContent = '0';
                avgNPKEl.textContent = '0';
                return;
            }
            
            // Find most calculated crop
            const cropCounts = {};
            let totalArea = 0;
            let totalNPKSum = 0;
            
            calculationHistory.forEach(item => {
                cropCounts[item.crop] = (cropCounts[item.crop] || 0) + 1;
                totalArea += parseFloat(item.area) || 0;
                totalNPKSum += parseFloat(item.totalNPK) || 0;
            });
            
            let mostCommonCrop = '-';
            let maxCount = 0;
            for (const crop in cropCounts) {
                if (cropCounts[crop] > maxCount) {
                    maxCount = cropCounts[crop];
                    mostCommonCrop = crop;
                }
            }
            
            mostCalculatedCropEl.textContent = mostCommonCrop;
            totalAreaEl.textContent = roundNumber(totalArea);
            avgNPKEl.textContent = roundNumber(totalNPKSum / total);
        }

        function displayHistory() {
            historyPanel.innerHTML = '';
            
            if (calculationHistory.length === 0) {
                emptyHistoryMessage.style.display = 'block';
                return;
            }
            
            emptyHistoryMessage.style.display = 'none';
            
            calculationHistory.slice().reverse().forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.dataset.id = item.id;
                
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div class="history-crop">${item.crop} - ${item.soilType}</div>
                        <div class="history-date">${item.date}</div>
                    </div>
                    <div class="history-details">
                        <div class="history-detail">
                            <div class="history-detail-label">Area</div>
                            <div class="history-detail-value">${roundNumber(item.area)} ha</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">N %</div>
                            <div class="history-detail-value">${item.nPercentage}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">P %</div>
                            <div class="history-detail-value">${item.pPercentage}</div>
                        </div>
                        <div class="history-detail">
                            <div class="history-detail-label">K %</div>
                            <div class="history-detail-value green">${item.kPercentage}</div>
                        </div>
                    </div>
                    <div class="history-actions">
                        <button class="history-delete-btn" onclick="deleteHistoryItem('${item.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                historyItem.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('history-delete-btn')) {
                        loadCalculation(item.id);
                    }
                });
                
                historyPanel.appendChild(historyItem);
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function deleteHistoryItem(id) {
            if (confirm("Are you sure you want to delete this calculation?")) {
                calculationHistory = calculationHistory.filter(item => item.id !== id);
                localStorage.setItem('fertilizerHistory', JSON.stringify(calculationHistory));
                updateHistoryStats();
                displayHistory();
                addMessage("Deleted calculation from history.");
            }
            event.stopPropagation();
        }

        function loadCalculation(id) {
            const calculation = calculationHistory.find(item => item.id === id);
            if (!calculation) return;
            
            document.getElementById('cropType').value = calculation.cropType;
            document.getElementById('soilType').value = calculation.soilType;
            document.getElementById('area').value = calculation.area;
            document.getElementById('soilN').value = calculation.soilN;
            document.getElementById('soilP').value = calculation.soilP;
            document.getElementById('soilK').value = calculation.soilK;
            
            setTimeout(() => {
                document.getElementById('calculateBtn').click();
            }, 100);
            
            document.querySelector('.calculator-section').scrollIntoView({ behavior: 'smooth' });
            addMessage(`Loaded previous calculation for ${calculation.crop} from ${calculation.date}.`);
        }

        function clearAllHistory() {
            if (calculationHistory.length === 0) {
                alert("No history to clear");
                return;
            }
            
            if (confirm("Are you sure you want to clear ALL calculation history? This action cannot be undone.")) {
                calculationHistory = [];
                localStorage.removeItem('fertilizerHistory');
                updateHistoryStats();
                displayHistory();
                
                const originalText = clearHistoryBtn.innerHTML;
                clearHistoryBtn.innerHTML = '<i class="fas fa-check"></i> Cleared!';
                clearHistoryBtn.style.background = 'linear-gradient(to right, var(--primary-green), var(--secondary-green))';
                
                setTimeout(() => {
                    clearHistoryBtn.innerHTML = originalText;
                    clearHistoryBtn.style.background = 'linear-gradient(to right, #e74c3c, #ff6b6b)';
                }, 2000);
                
                addMessage("Cleared all calculation history. " + calculationHistory.length + " calculations removed.");
            }
        }

        function exportHistory() {
            if (calculationHistory.length === 0) {
                alert("No history to export");
                return;
            }
            
            let csv = 'Crop,Soil Type,Area (ha),Soil N,Soil P,Soil K,N %,P %,K %,Total NPK,Date\n';
            
            calculationHistory.forEach(item => {
                csv += `"${item.crop}","${item.soilType}",${roundNumber(item.area)},${roundNumber(item.soilN)},${roundNumber(item.soilP)},${roundNumber(item.soilK)},${item.nPercentage},${item.pPercentage},${item.kPercentage},${roundNumber(item.totalNPK)},"${item.date}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `npk_calculations_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addMessage(`Exported ${calculationHistory.length} calculations to CSV file.`);
        }

        // Comprehensive chatbot responses
        const chatbotResponses = {
            // Fertilizer Definitions
            "what is fertilizer": "A <span class='highlight'>fertilizer</span> is any material of natural or synthetic origin applied to soils or plant tissues to supply essential plant nutrients. Fertilizers are classified as:<br><br>1. <strong>Organic Fertilizers</strong>: From plant/animal sources (manure, compost)<br>2. <strong>Inorganic Fertilizers</strong>: Chemically manufactured (urea, DAP, MOP)<br>3. <strong>Complete Fertilizers</strong>: Contain NPK (10-10-10, 20-20-20)<br>4. <strong>Specialty Fertilizers</strong>: For specific crops/conditions<br><br>Fertilizers improve soil fertility, increase crop yield, and enhance plant health.",
            
            "define fertilizer": "A <span class='highlight'>fertilizer</span> is a substance added to soil to improve plants' growth and yield by providing essential nutrients that may be deficient in the soil.",
            
            "what are fertilizers": "Fertilizers are materials containing essential plant nutrients. They can be:<br><br><strong>By Source:</strong> Organic or Inorganic<br><strong>By Nutrients:</strong> Nitrogenous, Phosphatic, Potassic, or Compound<br><strong>By Form:</strong> Solid, Liquid, or Gaseous<br><br>They supply nutrients like Nitrogen (N), Phosphorus (P), Potassium (K), Calcium, Magnesium, Sulfur, and micronutrients.",
            
            // NPK Definitions
            "what is npk": "NPK stands for <span class='highlight'>Nitrogen (N)</span>, <span class='highlight'>Phosphorus (P)</span>, and <span class='highlight green'>Potassium (K)</span> - the three primary macronutrients essential for plant growth:<br><br><strong>Nitrogen (N):</strong> For chlorophyll, proteins, and vegetative growth<br><strong>Phosphorus (P):</strong> For roots, flowers, fruits, and energy transfer<br><strong>Potassium (K):</strong> For water regulation, disease resistance, and overall health",
            
            "npk ratio explained": "The <span class='highlight'>NPK ratio</span> shows the percentage by weight of N, P, and K in fertilizer. Example: 10-10-10 has 10% each of N, P, and K. The ratio helps match fertilizer to crop needs:<br><br>• Leafy crops need high N (20-10-10)<br>• Flowering/fruiting need high P & K (10-20-20)<br>• Root crops need balanced NPK (10-10-10)",
            
            "what does npk mean": "NPK refers to the three numbers on fertilizer bags representing:<br><br>• <strong>N = Nitrogen</strong>: For green, leafy growth<br>• <strong>P = Phosphorus</strong>: For roots and flowers<br>• <strong>K = Potassium</strong>: For overall plant health<br><br>A 20-10-10 fertilizer has 20% N, 10% P, and 10% K.",
            
            // NPK Percentage Calculation
            "how to calculate npk percentage": "To calculate NPK percentage:<br><br><strong>Formula:</strong> (Individual NPK ÷ Total NPK) × 100 = Percentage<br><br><strong>Example:</strong> Crop needs 20N, 10P, 10K<br>• Total NPK = 20 + 10 + 10 = 40<br>• N % = (20 ÷ 40) × 100 = 50%<br>• P % = (10 ÷ 40) × 100 = 25%<br>• K % = (10 ÷ 40) × 100 = 25%<br><br>Our calculator does this automatically when you select crop, soil, and area.",
            
            "calculate npk %": "NPK percentage calculation formula:<br><br>1. <strong>Determine crop NPK needs</strong> (from our database)<br>2. <strong>Calculate total NPK</strong> = N + P + K<br>3. <strong>Calculate percentages</strong>:<br>   • N % = (N ÷ Total) × 100<br>   • P % = (P ÷ Total) × 100<br>   • K % = (K ÷ Total) × 100<br><br>Select a crop in the calculator to see actual percentages.",
            
            // Agriculture Definitions
            "what is agriculture": "<span class='highlight'>Agriculture</span> is the science and practice of cultivating plants and livestock. It includes:<br><br>1. <strong>Crop Production</strong>: Growing food, fiber, fuel crops<br>2. <strong>Soil Management</strong>: Maintaining soil health and fertility<br>3. <strong>Water Management</strong>: Irrigation and drainage<br>4. <strong>Pest Management</strong>: Controlling weeds, insects, diseases<br>5. <strong>Harvest Technology</strong>: Efficient harvesting and storage",
            
            "what is soil ph": "<span class='highlight'>Soil pH</span> measures acidity/alkalinity on 0-14 scale. Most crops prefer pH 6.0-7.5. pH affects:<br><br>• Nutrient availability to plants<br>• Microbial activity in soil<br>• Soil structure and root growth<br><br><strong>Adjust pH:</strong> Add lime to raise pH, sulfur to lower pH.",
            
            "soil types explained": "Main soil types:<br><br>1. <strong>Clay Soil</strong>: Fine particles, retains water/nutrients, poor drainage<br>2. <strong>Sandy Soil</strong>: Coarse particles, drains quickly, low nutrient retention<br>3. <strong>Loam Soil</strong>: Ideal mix of sand, silt, clay - best for crops<br>4. <strong>Silty Soil</strong>: Medium particles, fertile, holds moisture<br>5. <strong>Peat Soil</strong>: High organic matter, acidic, retains moisture<br>6. <strong>Chalky Soil</strong>: Alkaline, free-draining, may lack nutrients",
            
            // Crop-specific fertilizer
            "best fertilizer for tomatoes": "For <span class='highlight'>Tomatoes</span>:<br><br><strong>Recommended NPK:</strong> 5-10-10 or 10-10-10 early, 5-10-20 during fruiting<br><strong>Special Needs:</strong><br>• High potassium for fruit quality<br>• Calcium prevents blossom end rot<br>• Magnesium for chlorophyll<br><strong>Application:</strong> Balanced at transplanting, high-K during flowering/fruiting",
            
            "best fertilizer for wheat": "For <span class='highlight'>Wheat</span>:<br><br><strong>Recommended NPK:</strong> 20-20-0 or 18-46-0 at sowing<br><strong>Requirements:</strong> 25N-12P-10K per 1000kg yield<br><strong>Application:</strong> 50% N at sowing, 50% at first irrigation. All P at sowing.",
            
            "best fertilizer for corn": "For <span class='highlight'>Corn</span>:<br><br><strong>Recommended NPK:</strong> 28-28-0 or 10-26-26 at sowing<br><strong>Requirements:</strong> 30N-15P-25K per 1000kg yield<br><strong>Application:</strong> 1/3 N at sowing, 2/3 at knee-high stage. All P at sowing.",
            
            // Calculator usage
            "how to use this calculator": "To use the NPK Percentage Calculator:<br><br>1. <strong>Select Crop</strong>: Choose from 20+ crops<br>2. <strong>Select Soil Type</strong>: Clay, loam, sandy, etc.<br>3. <strong>Enter Field Size</strong>: In hectares<br>4. <strong>Enter Soil NPK</strong>: Current soil nutrient levels<br>5. <strong>Click Calculate</strong>: Get NPK percentages<br><br>The calculator shows:<br>• Required NPK in kg<br>• NPK percentage composition<br>• Fertilizer recommendations",
            
            // Soil management
            "how to improve soil fertility": "Improve soil fertility by:<br><br>1. <strong>Add Organic Matter</strong>: Compost, manure, cover crops<br>2. <strong>Practice Crop Rotation</strong>: Different crops each season<br>3. <strong>Use Green Manure</strong>: Grow and plow under legumes<br>4. <strong>Apply Balanced Fertilizers</strong>: Based on soil tests<br>5. <strong>Maintain Soil pH</strong>: 6.0-7.5 for most crops<br>6. <strong>Conserve Soil Moisture</strong>: Mulching, proper irrigation",
            
            // Fertilizer application
            "when to apply fertilizer": "Best fertilizer timing:<br><br><strong>Nitrogen (N):</strong> Split applications - at planting and during growth<br><strong>Phosphorus (P):</strong> At planting (immobile in soil)<br><strong>Potassium (K):</strong> Before flowering and fruiting<br><strong>General Rule:</strong> Apply when plants are actively growing, not during dormancy.",
            
            // Precision agriculture
            "what is precision agriculture": "<span class='highlight'>Precision Agriculture</span> uses technology for optimal field management:<br><br>1. <strong>GPS Technology</strong>: For precise field mapping<br>2. <strong>Sensors</strong>: Monitor soil and crop conditions<br>3. <strong>Variable Rate Technology</strong>: Apply inputs based on need<br>4. <strong>Data Analytics</strong>: Make informed decisions<br><br>Benefits: Increased efficiency, reduced waste, improved yields.",
            
            // Organic farming
            "what is organic farming": "<span class='highlight'>Organic farming</span> avoids synthetic inputs and emphasizes:<br><br>1. <strong>Soil Health</strong>: Compost, cover crops, rotation<br>2. <strong>Biodiversity</strong>: Ecological balance<br>3. <strong>Natural Pest Control</strong>: Biological methods<br>4. <strong>Sustainability</strong>: Environmental protection<br><br>Uses organic fertilizers like manure, compost, bone meal.",
            
            // Irrigation
            "what is irrigation": "<span class='highlight'>Irrigation</span> is artificial water application for crops:<br><br>1. <strong>Surface Irrigation</strong>: Flood, furrow<br>2. <strong>Sprinkler Irrigation</strong>: Center pivot, traveling gun<br>3. <strong>Drip Irrigation</strong>: Most efficient, direct to roots<br>4. <strong>Subsurface Irrigation</strong>: Below soil surface<br><br>Proper irrigation maximizes water use efficiency.",
            
            // Pest management
            "what is integrated pest management": "<span class='highlight'>Integrated Pest Management (IPM)</span> combines:<br><br>1. <strong>Biological Control</strong>: Natural predators<br>2. <strong>Cultural Practices</strong>: Crop rotation, sanitation<br>3. <strong>Mechanical Control</strong>: Traps, barriers<br>4. <strong>Chemical Control</strong>: Targeted pesticide use<br><br>IPM minimizes risks while managing pests effectively."
        };

        const defaultResponses = [
            "I can help with questions about NPK percentages, fertilizer calculations, crop management, soil science, and agriculture. What would you like to know?",
            "I specialize in agriculture topics including NPK calculations, fertilizer definitions, crop requirements, and soil management. Ask me anything!",
            "As your Agriculture Assistant, I can explain NPK percentages, fertilizer types, crop nutrition, and farming practices. How can I assist you?"
        ];

        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (isUser) {
                // Add delete button to user messages
                messageDiv.innerHTML = `
                    ${message}
                    <button class="delete-message-btn" onclick="deleteMessage(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                userMessageElements.push(messageDiv);
            } else {
                messageDiv.innerHTML = message;
            }
            
            chatMessages.appendChild(messageDiv);
            messages++;
            updateMessageCount();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function deleteMessage(button) {
            const messageDiv = button.parentElement;
            messageDiv.remove();
            messages--;
            updateMessageCount();
            
            // Remove from userMessageElements array
            const index = userMessageElements.indexOf(messageDiv);
            if (index > -1) {
                userMessageElements.splice(index, 1);
            }
        }

        function deleteLastUserMessage() {
            if (userMessageElements.length > 0) {
                const lastMessage = userMessageElements.pop();
                lastMessage.remove();
                messages--;
                updateMessageCount();
                addMessage("Deleted your last message.");
            } else {
                addMessage("No user messages to delete.");
            }
        }

        function clearChat() {
            if (confirm("Clear all chat messages?")) {
                chatMessages.innerHTML = '';
                userMessageElements = [];
                messages = 0;
                updateMessageCount();
                
                // Add welcome message back
                addMessage("Hello! I'm your Agriculture Assistant. I can answer questions about fertilizer calculations, NPK ratios, crop management, soil science, and all agriculture-related topics. How can I help you today?");
            }
        }

        function getBotResponse(question) {
            const lowerQuestion = question.toLowerCase().trim();
            
            for (const key in chatbotResponses) {
                if (lowerQuestion.includes(key)) {
                    return chatbotResponses[key];
                }
            }
            
            if (lowerQuestion.includes('percentage') || lowerQuestion.includes('percent') || lowerQuestion.includes('%')) {
                return chatbotResponses["how to calculate npk percentage"];
            }
            
            if (lowerQuestion.includes('fertilizer') && (lowerQuestion.includes('what') || lowerQuestion.includes('define'))) {
                return chatbotResponses["what is fertilizer"];
            }
            
            if (lowerQuestion.includes('npk') && (lowerQuestion.includes('what') || lowerQuestion.includes('mean'))) {
                return chatbotResponses["what is npk"];
            }
            
            if (lowerQuestion.includes('tomato') && lowerQuestion.includes('fertilizer')) {
                return chatbotResponses["best fertilizer for tomatoes"];
            }
            
            if (lowerQuestion.includes('wheat') && lowerQuestion.includes('fertilizer')) {
                return chatbotResponses["best fertilizer for wheat"];
            }
            
            if (lowerQuestion.includes('corn') && lowerQuestion.includes('fertilizer')) {
                return chatbotResponses["best fertilizer for corn"];
            }
            
            if (lowerQuestion.includes('soil type')) {
                return chatbotResponses["soil types explained"];
            }
            
            if (lowerQuestion.includes('agriculture')) {
                return chatbotResponses["what is agriculture"];
            }
            
            if (lowerQuestion.includes('calculator') || lowerQuestion.includes('use this')) {
                return chatbotResponses["how to use this calculator"];
            }
            
            if (lowerQuestion.includes('soil fertility')) {
                return chatbotResponses["how to improve soil fertility"];
            }
            
            if (lowerQuestion.includes('precision agriculture')) {
                return chatbotResponses["what is precision agriculture"];
            }
            
            if (lowerQuestion.includes('organic farm')) {
                return chatbotResponses["what is organic farming"];
            }
            
            if (lowerQuestion.includes('irrigation')) {
                return chatbotResponses["what is irrigation"];
            }
            
            if (lowerQuestion.includes('pest management') || lowerQuestion.includes('ipm')) {
                return chatbotResponses["what is integrated pest management"];
            }
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        // Event Listeners
        sendBtn.addEventListener('click', function() {
            const question = chatInput.value.trim();
            if (question) {
                addMessage(question, true);
                chatInput.value = '';
                
                setTimeout(() => {
                    const response = getBotResponse(question);
                    addMessage(response);
                }, 600);
            }
        });

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        quickQuestions.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.getAttribute('data-question');
                chatInput.value = question;
                sendBtn.click();
            });
        });

        // Chat management buttons
        clearChatBtn.addEventListener('click', clearChat);
        deleteLastMessageBtn.addEventListener('click', deleteLastUserMessage);

        // History buttons
        clearHistoryBtn.addEventListener('click', clearAllHistory);
        exportHistoryBtn.addEventListener('click', exportHistory);

        // Help and tutorial buttons
        helpBtn.addEventListener('click', function() {
            helpModal.style.display = 'flex';
        });

        closeHelpBtn.addEventListener('click', function() {
            helpModal.style.display = 'none';
        });

        helpModal.addEventListener('click', function(e) {
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        tutorialBtn.addEventListener('click', function() {
            window.open('https://www.youtube.com/results?search_query=npk+fertilizer+application+tutorial', '_blank');
        });

        // Calculator functionality
        const calculateBtn = document.getElementById('calculateBtn');
        const resultContainer = document.getElementById('resultContainer');
        
        calculateBtn.addEventListener('click', function() {
            const cropType = document.getElementById('cropType').value;
            const soilN = parseFloat(document.getElementById('soilN').value);
            const soilP = parseFloat(document.getElementById('soilP').value);
            const soilK = parseFloat(document.getElementById('soilK').value);
            const area = parseFloat(document.getElementById('area').value);
            const soilType = document.getElementById('soilType').value;
            
            if (!cropType) {
                alert("Please select a crop type");
                return;
            }
            
            if (area <= 0) {
                alert("Please enter a valid field size");
                return;
            }
            
            // Get crop data
            const crop = cropData[cropType];
            const req = crop.npkRatio;
            const totalNPK = crop.totalNPK;
            
            // Apply soil type adjustments
            const soilAdjustment = soilTypeAdjustments[soilType];
            const adjustedN = req.n * soilAdjustment.n;
            const adjustedP = req.p * soilAdjustment.p;
            const adjustedK = req.k * soilAdjustment.k;
            
            // Adjust for area and round numbers
            const nTotal = roundNumber(adjustedN * area);
            const pTotal = roundNumber(adjustedP * area);
            const kTotal = roundNumber(adjustedK * area);
            const totalNPKAdjusted = roundNumber(parseFloat(nTotal) + parseFloat(pTotal) + parseFloat(kTotal));
            
            // Calculate percentages using formula: (Crop NPK Ratio ÷ Total NPK) × 100
            // Use original crop NPK values for percentage calculation
            const nPercentage = roundNumber((req.n / totalNPK) * 100);
            const pPercentage = roundNumber((req.p / totalNPK) * 100);
            const kPercentage = roundNumber((req.k / totalNPK) * 100);
            
            // Display results (rounded numbers without decimals)
            document.getElementById('nResult').textContent = `${nTotal} kg`;
            document.getElementById('pResult').textContent = `${pTotal} kg`;
            document.getElementById('kResult').textContent = `${kTotal} kg`;
            document.getElementById('totalResult').textContent = `${totalNPKAdjusted} kg`;
            
            // Display percentages (rounded numbers without decimals)
            document.getElementById('nPercentage').textContent = `${nPercentage}%`;
            document.getElementById('pPercentage').textContent = `${pPercentage}%`;
            document.getElementById('kPercentage').textContent = `${kPercentage}%`;
            
            // Display recommendation
            document.getElementById('recommendationText').textContent = recommendations[cropType] || 
                `Apply balanced fertilizer based on the calculated NPK percentages. N: ${nPercentage}%, P: ${pPercentage}%, K: ${kPercentage}%`;
            
            // Show result container
            resultContainer.style.display = 'block';
            resultContainer.style.opacity = '0';
            resultContainer.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                resultContainer.style.transition = 'all 0.5s ease';
                resultContainer.style.opacity = '1';
                resultContainer.style.transform = 'translateY(0)';
            }, 10);
            
            // Save to history
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const calculation = {
                id: generateId(),
                crop: crop.name,
                cropType: cropType,
                soilType: soilType,
                area: area,
                soilN: soilN,
                soilP: soilP,
                soilK: soilK,
                nResult: nTotal,
                pResult: pTotal,
                kResult: kTotal,
                totalNPK: totalNPKAdjusted,
                nPercentage: nPercentage + '%',
                pPercentage: pPercentage + '%',
                kPercentage: kPercentage + '%',
                date: dateStr,
                timestamp: now.getTime()
            };
            
            // Check for duplicates (within 5 minutes)
            const recentCalculation = calculationHistory.find(item => 
                item.cropType === cropType && 
                Math.abs(item.timestamp - now.getTime()) < 300000
            );
            
            if (!recentCalculation) {
                calculationHistory.push(calculation);
                localStorage.setItem('fertilizerHistory', JSON.stringify(calculationHistory));
                updateHistoryStats();
                displayHistory();
            }
            
            // Add chatbot message
            setTimeout(() => {
                addMessage(`Calculated NPK percentages for <span class='highlight'>${crop.name}</span>:<br><br><strong>NPK Composition:</strong> N ${nPercentage}%, P ${pPercentage}%, K ${kPercentage}%<br><strong>Total Requirement:</strong> ${totalNPKAdjusted} kg for ${roundNumber(area)} hectares<br><strong>Formula Used:</strong> (Crop NPK Ratio ÷ Total NPK) × 100 = Percentage<br><strong>All numbers rounded to whole numbers for simplicity.</strong>`);
            }, 800);
        });
        
        // Initialize
        window.addEventListener('load', function() {
            document.getElementById('cropType').value = 'tomato';
            
            setTimeout(() => {
                calculateBtn.click();
            }, 1000);
        });

        // Make functions available globally
        window.deleteMessage = deleteMessage;
        window.deleteHistoryItem = deleteHistoryItem;
        window.roundNumber = roundNumber;
    </script>
</body>
</html>
